<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Äang Táº£i YÃªu ThÆ°Æ¡ng...</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="loading-page">
    <div class="loading-container">
        <h2>Má»™t Bá»©c ThÆ° Äáº·c Biá»‡t</h2>
        <p class="instruction-text">KÃ©o cÃ¡nh thÆ° sang pháº£i Ä‘á»ƒ má»Ÿ khÃ³a Ä‘iá»u báº¥t ngá» nhÃ©!</p>
        <div class="slider-container" id="sliderContainer">
            <div class="slider-track">
                <div class="slider-progress" id="sliderProgress"></div>
                <div class="letter-icon" id="letterIcon">ğŸ’Œ</div>
                <div class="track-text">KÃ‰O Äá»‚ Má»</div>
            </div>
        </div>
        <p id="loadingText">Äang chá» Ä‘á»£i... 0%</p>
        <button id="revealButton" style="display:none;">áº¤n VÃ o ÄÃ¢y NÃ¨!</button>
    </div>

    <audio id="dragMusic" src="assets/nhac-keo-thu.mp3" loop></audio>
    <audio id="successSound" src="assets/nhac-thanh-cong.mp3"></audio>
    <audio id="clickSound" src="assets/nhac-click.mp3"></audio>

    <script>
        // Kiá»ƒm tra Ä‘Äƒng nháº­p (Ä‘á»ƒ báº£o vá»‡ trang)
        if (localStorage.getItem('isLoggedIn') !== 'true') {
            // window.location.href = 'index.html';
        }

        const sliderContainer = document.getElementById('sliderContainer');
        const letterIcon = document.getElementById('letterIcon');
        const sliderProgress = document.getElementById('sliderProgress');
        const loadingText = document.getElementById('loadingText');
        const revealButton = document.getElementById('revealButton');

        const dragMusic = document.getElementById('dragMusic');
        const successSound = document.getElementById('successSound');
        const clickSound = document.getElementById('clickSound');

        let isDragging = false;
        let isCompleted = false;
        // Bá» biáº¿n musicPlayedOnce, sáº½ dá»±a vÃ o isDragging vÃ  dragMusic.paused

        const startDrag = (e) => {
            if (isCompleted) return; // Náº¿u Ä‘Ã£ hoÃ n thÃ nh thÃ¬ khÃ´ng lÃ m gÃ¬
            isDragging = true;
            letterIcon.classList.add('dragging'); // ThÃªm class Ä‘á»ƒ CSS cÃ³ thá»ƒ báº¯t (tÃ¹y chá»n)

            // PhÃ¡t nháº¡c ná»n khi kÃ©o
            if (dragMusic && dragMusic.paused) {
                dragMusic.play().catch(error => console.log("Lá»—i phÃ¡t nháº¡c kÃ©o:", error));
            }
        };

        const endDrag = (e) => {
            if (!isDragging) return; // Chá»‰ xá»­ lÃ½ náº¿u Ä‘ang trong tráº¡ng thÃ¡i kÃ©o
            
            isDragging = false;
            letterIcon.classList.remove('dragging');

            if (isCompleted) return; // Náº¿u Ä‘Ã£ hoÃ n thÃ nh trong lÃºc kÃ©o (onDrag Ä‘Ã£ xá»­ lÃ½) thÃ¬ khÃ´ng lÃ m gÃ¬ thÃªm

            const progress = parseFloat(sliderProgress.style.width) || 0;
            if (progress < 99) {
                // TrÆ°á»£t vá» vá»‹ trÃ­ ban Ä‘áº§u náº¿u chÆ°a hoÃ n thÃ nh
                letterIcon.style.left = '0px';
                sliderProgress.style.width = '0%';
                loadingText.textContent = `Äang chá» Ä‘á»£i... 0%`;
                if (dragMusic && !dragMusic.paused) {
                    dragMusic.pause();
                    dragMusic.currentTime = 0;
                }
            }
        };

        const onDrag = (e) => {
            if (!isDragging || isCompleted) return;

            // NgÄƒn hÃ nh vi máº·c Ä‘á»‹nh nhÆ° chá»n text hoáº·c cuá»™n trang (quan trá»ng)
            e.preventDefault();

            const clientX = e.type.startsWith('touch') ? e.touches[0].clientX : e.clientX;
            const trackRect = sliderContainer.getBoundingClientRect(); // Láº¥y vá»‹ trÃ­ track má»—i láº§n drag Ä‘á»ƒ chÃ­nh xÃ¡c hÆ¡n
            const iconWidth = letterIcon.offsetWidth;

            let newLeft = clientX - trackRect.left - (iconWidth / 2);
            const maxLeft = trackRect.width - iconWidth;
            
            newLeft = Math.max(0, Math.min(newLeft, maxLeft));

            letterIcon.style.left = newLeft + 'px';
            const progress = (newLeft / maxLeft) * 100;
            sliderProgress.style.width = progress + '%';
            loadingText.textContent = `Äang má»Ÿ khÃ³a... ${Math.round(progress)}%`;

            if (progress >= 99 && !isCompleted) { // ThÃªm !isCompleted Ä‘á»ƒ Ä‘áº£m báº£o chá»‰ cháº¡y 1 láº§n
                isCompleted = true; // Äáº·t isCompleted á»Ÿ Ä‘Ã¢y
                // isDragging = false; // KhÃ´ng cáº§n Ä‘áº·t isDragging = false á»Ÿ Ä‘Ã¢y, endDrag sáº½ xá»­ lÃ½ hoáº·c nÃ³ sáº½ tá»± dá»«ng do !isDragging á»Ÿ Ä‘áº§u hÃ m
                
                sliderContainer.classList.add('completed');
                loadingText.textContent = 'ÄÃ£ má»Ÿ khÃ³a thÃ nh cÃ´ng!';

                if (dragMusic && !dragMusic.paused) {
                    dragMusic.pause();
                    dragMusic.currentTime = 0;
                }
                if(successSound) {
                    successSound.play().catch(error => console.log("Lá»—i phÃ¡t nháº¡c thÃ nh cÃ´ng:", error));
                }

                setTimeout(() => {
                    revealButton.style.display = 'block';
                }, 500);
            }
        };

        // Gáº¯n sá»± kiá»‡n cho chuá»™t
        letterIcon.addEventListener('mousedown', startDrag);
        document.addEventListener('mousemove', onDrag);
        document.addEventListener('mouseup', endDrag);

        // Gáº¯n sá»± kiá»‡n cho cáº£m á»©ng
        // passive: false lÃ  quan trá»ng Ä‘á»ƒ e.preventDefault() trong onDrag hoáº¡t Ä‘á»™ng Ä‘Ãºng
        letterIcon.addEventListener('touchstart', startDrag, { passive: false });
        document.addEventListener('touchmove', onDrag, { passive: false });
        document.addEventListener('touchend', endDrag);


        revealButton.addEventListener('click', function() {
            if(successSound && !successSound.paused) {
                successSound.pause();
                successSound.currentTime = 0;
            }
            clickSound.play().catch(error => console.log("Lá»—i phÃ¡t nháº¡c click:", error));
            setTimeout(() => {
                window.location.href = 'message.html';
            }, clickSound.duration > 0 ? clickSound.duration * 1000 : 500);
        });

    </script>
</body>
</html>