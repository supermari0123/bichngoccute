// js/confession-script.js
const confessionContainer = document.getElementById('confessionContainer');
const noButton = document.getElementById('noButton');
const yesButton = document.getElementById('yesButton');
const confessionMusic = document.getElementById('confessionMusic');
const yesSound = document.getElementById('yesSound');
const buttonsArea = document.querySelector('.buttons-area');

let noButtonClickCount = 0;
const baseYesButtonFontSize = 1.15; // em, kh·ªõp v·ªõi CSS
const baseYesButtonPaddingHorizontal = 28; // px
const baseYesButtonPaddingVertical = 14; // px

let initialNoButtonPos = { x: 0, y: 0 };
let initialYesButtonPos = { x: 0, y: 0 };
let allowButtonMouseMoveEffect = true; // C·ªù ƒë·ªÉ ki·ªÉm so√°t hi·ªáu ·ª©ng di chu·ªôt

function setInitialButtonPositions() {
    if (!buttonsArea || !noButton || !yesButton) {
        console.error("M·ªôt ho·∫∑c nhi·ªÅu ph·∫ßn t·ª≠ n√∫t kh√¥ng t√¨m th·∫•y!");
        return;
    }

    // ƒê·∫£m b·∫£o c√°c n√∫t hi·ªÉn th·ªã ƒë·ªÉ l·∫•y k√≠ch th∆∞·ªõc ch√≠nh x√°c
    noButton.style.display = 'inline-block';
    yesButton.style.display = 'inline-block';
    noButton.style.opacity = '1'; // ƒê·∫£m b·∫£o n√∫t "Kh√¥ng" hi·ªán r√µ r√†ng

    const areaWidth = buttonsArea.offsetWidth;
    const areaHeight = buttonsArea.offsetHeight;
    const noBtnWidth = noButton.offsetWidth;
    const noBtnHeight = noButton.offsetHeight;
    const yesBtnWidth = yesButton.offsetWidth;
    const yesBtnHeight = yesButton.offsetHeight;

    initialNoButtonPos.x = (areaWidth / 2) - noBtnWidth - 20; // 20 l√† n·ª≠a c·ªßa gap (40px)
    initialNoButtonPos.y = (areaHeight / 2) - (noBtnHeight / 2);
    
    initialYesButtonPos.x = (areaWidth / 2) + 20;
    initialYesButtonPos.y = (areaHeight / 2) - (yesBtnHeight / 2);

    noButton.style.left = initialNoButtonPos.x + 'px';
    noButton.style.top = initialNoButtonPos.y + 'px';
    yesButton.style.left = initialYesButtonPos.x + 'px';
    yesButton.style.top = initialYesButtonPos.y + 'px';

    // Reset transform v√† scale
    noButton.style.transform = 'translate(0px, 0px) scale(1)';
    yesButton.style.transform = 'translate(0px, 0px) scale(1)';
    // Reset font-size v√† padding cho n√∫t "C√≥"
    yesButton.style.fontSize = baseYesButtonFontSize + 'em';
    yesButton.style.padding = `${baseYesButtonPaddingVertical}px ${baseYesButtonPaddingHorizontal}px`;

    noButtonClickCount = 0; // Reset b·ªô ƒë·∫øm
    allowButtonMouseMoveEffect = true; // Cho ph√©p hi·ªáu ·ª©ng di chu·ªôt l·∫°i
    noButton.style.pointerEvents = 'auto'; // Cho ph√©p click l·∫°i n√∫t "Kh√¥ng"
}

window.addEventListener('DOMContentLoaded', () => {
    setInitialButtonPositions();

    function playConfessionMusic() {
        if (confessionMusic && confessionMusic.paused) {
            confessionMusic.play().catch(e => console.warn("L·ªói ph√°t nh·∫°c t·ªè t√¨nh:", e));
        }
        document.body.removeEventListener('mousemove', playConfessionMusic);
        document.body.removeEventListener('click', playConfessionMusic);
        document.body.removeEventListener('touchstart', playConfessionMusic);
    }
    document.body.addEventListener('mousemove', playConfessionMusic, { once: true });
    document.body.addEventListener('click', playConfessionMusic, { once: true });
    document.body.addEventListener('touchstart', playConfessionMusic, { once: true });
});

// G·ªçi l·∫°i khi thay ƒë·ªïi k√≠ch th∆∞·ªõc c·ª≠a s·ªï
let resizeTimeout;
window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(setInitialButtonPositions, 200); // Debounce
});


buttonsArea.addEventListener('mousemove', (e) => {
    if (!allowButtonMouseMoveEffect) return;

    const rect = buttonsArea.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;
    const moveFactor = 0.07;

    // Di chuy·ªÉn n√∫t "Kh√¥ng"
    if (noButton.style.display !== 'none') {
        const noBtnCenterX = parseFloat(noButton.style.left) + noButton.offsetWidth / 2;
        const noBtnCenterY = parseFloat(noButton.style.top) + noButton.offsetHeight / 2;
        let noDeltaX = (mouseX - noBtnCenterX) * -moveFactor;
        let noDeltaY = (mouseY - noBtnCenterY) * -moveFactor;
        noDeltaX = Math.max(-15, Math.min(15, noDeltaX));
        noDeltaY = Math.max(-15, Math.min(15, noDeltaY));
        noButton.style.transform = `translate(${noDeltaX}px, ${noDeltaY}px) scale(${1 - noButtonClickCount * 0.1})`;
    }

    // Di chuy·ªÉn n√∫t "C√≥"
    const yesBtnCenterX = parseFloat(yesButton.style.left) + yesButton.offsetWidth / 2;
    const yesBtnCenterY = parseFloat(yesButton.style.top) + yesButton.offsetHeight / 2;
    let yesDeltaX = (mouseX - yesBtnCenterX) * -moveFactor;
    let yesDeltaY = (mouseY - yesBtnCenterY) * -moveFactor;
    yesDeltaX = Math.max(-20, Math.min(20, yesDeltaX));
    yesDeltaY = Math.max(-20, Math.min(20, yesDeltaY));
    yesButton.style.transform = `translate(${yesDeltaX}px, ${yesDeltaY}px) scale(${1 + noButtonClickCount * 0.1})`;
});

buttonsArea.addEventListener('mouseleave', () => {
    if (!allowButtonMouseMoveEffect) return;
    if (noButton.style.display !== 'none') {
        noButton.style.transform = `translate(0px, 0px) scale(${1 - noButtonClickCount * 0.1})`;
    }
    yesButton.style.transform = `translate(0px, 0px) scale(${1 + noButtonClickCount * 0.1})`;
});


noButton.addEventListener('click', () => {
    noButtonClickCount++;
    
    const newYesFontSize = baseYesButtonFontSize + (noButtonClickCount * 0.2);
    const newYesPaddingH = baseYesButtonPaddingHorizontal + (noButtonClickCount * 3.5);
    const newYesPaddingV = baseYesButtonPaddingVertical + (noButtonClickCount * 2);

    yesButton.style.fontSize = newYesFontSize + 'em';
    yesButton.style.padding = `${newYesPaddingV}px ${newYesPaddingH}px`;
    // N√∫t "C√≥" s·∫Ω t·ª± to ra, hi·ªáu ·ª©ng scale t·ª´ mousemove s·∫Ω c·∫≠p nh·∫≠t theo k√≠ch th∆∞·ªõc m·ªõi
    // C·∫ßn t√≠nh l·∫°i v·ªã tr√≠ n√∫t "C√≥" ƒë·ªÉ n√≥ kh√¥ng b·ªã l·ªách khi to ra qu√° nhi·ªÅu (n·∫øu c·∫ßn)
    // Hi·ªán t·∫°i ƒë·ªÉ n√≥ to ra t·ª´ v·ªã tr√≠ g·ªëc c·ªßa n√≥

    // L√†m n√∫t "Kh√¥ng" nh·ªè l·∫°i v√† di chuy·ªÉn ng·∫´u nhi√™n
    noButton.style.transform = `translate(0px, 0px) scale(${1 - noButtonClickCount * 0.18})`;

    if (noButtonClickCount >= 1) { // Di chuy·ªÉn ngay t·ª´ l·∫ßn click ƒë·∫ßu
        const areaWidth = buttonsArea.offsetWidth;
        const areaHeight = buttonsArea.offsetHeight;
        // L·∫•y k√≠ch th∆∞·ªõc hi·ªán t·∫°i c·ªßa n√∫t sau khi c√≥ th·ªÉ ƒë√£ scale
        const noBtnCurrentWidth = noButton.getBoundingClientRect().width;
        const noBtnCurrentHeight = noButton.getBoundingClientRect().height;
        
        const yesBtnRect = yesButton.getBoundingClientRect(); // V·ªã tr√≠ v√† k√≠ch th∆∞·ªõc hi·ªán t·∫°i c·ªßa n√∫t "C√≥"
        const buttonsAreaGlobalRect = buttonsArea.getBoundingClientRect(); // T·ªça ƒë·ªô to√†n c·ª•c c·ªßa v√πng n√∫t

        let randomX, randomY, attempts = 0;
        do {
            randomX = Math.random() * (areaWidth - noBtnCurrentWidth);
            randomY = Math.random() * (areaHeight - noBtnCurrentHeight);
            attempts++;

            // T·∫°o rect ·∫£o cho v·ªã tr√≠ m·ªõi c·ªßa n√∫t "Kh√¥ng" (t·ªça ƒë·ªô to√†n c·ª•c)
            const noBtnNewGlobalRect = {
                left: buttonsAreaGlobalRect.left + randomX,
                top: buttonsAreaGlobalRect.top + randomY,
                right: buttonsAreaGlobalRect.left + randomX + noBtnCurrentWidth,
                bottom: buttonsAreaGlobalRect.top + randomY + noBtnCurrentHeight
            };
            // Ki·ªÉm tra ch·ªìng l·∫•n v·ªõi n√∫t "C√≥"
            const overlaps = !(yesBtnRect.right < noBtnNewGlobalRect.left ||
                               yesBtnRect.left > noBtnNewGlobalRect.right ||
                               yesBtnRect.bottom < noBtnNewGlobalRect.top ||
                               yesBtnRect.top > noBtnNewGlobalRect.bottom);
            if (!overlaps || attempts > 30) break;
        } while (true);

        noButton.style.left = randomX + 'px';
        noButton.style.top = randomY + 'px';
    }

    const noButtonMessages = ["Suy nghƒ© l·∫°i ƒëi m√†ü•∫", "C∆° h·ªôi cu·ªëi? üòü", "ƒê·ª´ng l√†m t·ªõ bu·ªìn...üíî", "Th·∫≠t s·ª± kh√¥ng √°? üò≠"];
    if (noButtonClickCount <= noButtonMessages.length) {
        noButton.textContent = noButtonMessages[noButtonClickCount -1];
    }


    if (noButtonClickCount >= 5) { // Sau 5 l·∫ßn nh·∫•n "Kh√¥ng"
        noButton.style.opacity = '0';
        noButton.style.pointerEvents = 'none';
        allowButtonMouseMoveEffect = false; // D·ª´ng hi·ªáu ·ª©ng di chu·ªôt khi n√∫t "Kh√¥ng" ·∫©n
        setTimeout(() => {
            noButton.style.display = 'none';
        }, 300);
        // L√†m n√∫t "C√≥" chi·∫øm gi·ªØa v√† to h∆°n n·ªØa
        yesButton.style.left = (buttonsArea.offsetWidth / 2 - yesButton.offsetWidth / 2) + 'px';
        yesButton.style.top = (buttonsArea.offsetHeight / 2 - yesButton.offsetHeight / 2) + 'px';
        yesButton.style.fontSize = (baseYesButtonFontSize + (noButtonClickCount * 0.25)) + 'em'; // To h∆°n n·ªØa
        yesButton.style.padding = `${baseYesButtonPaddingVertical + (noButtonClickCount * 3)}px ${baseYesButtonPaddingHorizontal + (noButtonClickCount*5)}px`;
        yesButton.style.transform = 'translate(0px, 0px) scale(1.1)'; // H∆°i ph√≥ng to th√™m
    }
});

yesButton.addEventListener('click', () => {
    allowButtonMouseMoveEffect = false; // D·ª´ng hi·ªáu ·ª©ng di chu·ªôt
    if (confessionMusic && !confessionMusic.paused) {
        confessionMusic.pause();
        confessionMusic.currentTime = 0;
    }
    if (yesSound) {
        yesSound.play().catch(e => console.warn("L·ªói ph√°t √¢m thanh ƒë·ªìng √Ω:", e));
    }

    // ·∫®n c√°c n√∫t
    noButton.style.display = 'none';
    yesButton.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
    yesButton.style.opacity = '0';
    yesButton.style.transform = 'scale(0.8)';


    setTimeout(() => { // ƒê·ª£i n√∫t "C√≥" ·∫©n ƒëi r·ªìi m·ªõi thay ƒë·ªïi n·ªôi dung
        yesButton.style.display = 'none';
        confessionContainer.innerHTML = `
            <div class="final-message" style="opacity:0; transform: scale(0.8);">
                <h2>T·ªõ bi·∫øt c·∫≠u s·∫Ω ƒë·ªìng √Ω m√†! Y√™u c·∫≠u nhi·ªÅu l·∫Øm! ‚ù§Ô∏è</h2>
                <p>Gi·ªù th√¨ ƒë·∫øn v·ªõi l·ªùi ch√∫c ƒë·∫∑c bi·ªát nh·∫•t n√®...</p>
            </div>
        `;
        const finalMsgElement = document.querySelector('.final-message');
        // Trigger reflow ƒë·ªÉ animation ho·∫°t ƒë·ªông
        void finalMsgElement.offsetWidth; 
        
        finalMsgElement.style.transition = 'opacity 0.7s ease-out 0.2s, transform 0.7s ease-out 0.2s';
        finalMsgElement.style.opacity = '1';
        finalMsgElement.style.transform = 'scale(1)';
    }, 300); // Th·ªùi gian kh·ªõp v·ªõi transition c·ªßa n√∫t "C√≥"


    setTimeout(() => {
        window.location.href = 'message.html';
    }, 3500);
});